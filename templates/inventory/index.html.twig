{% extends 'base.html.twig' %}

{% block title %}My Inventories{% endblock %}

{% block body %}
<div class="container py-5">
    {# Header Section #}
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-5 gap-3">
        <div>
            <h1 class="fw-bold tracking-tight text-dark mb-1">{{ 'dashboard.title'|trans }}</h1>
            <p class="text-muted mb-0 small">{{ 'dashboard.total_collections'|trans }}: {{ pagination.getTotalItemCount }}</p>
        </div>
        {% if is_granted('ROLE_USER') %}
            <a href="{{ path('app_salesforce_sync') }}" class="btn btn-outline-primary">
                Connect to Salesforce
            </a>
        {% endif %}
        <a href="{{ path('app_inventory_new') }}" class="btn btn-outline-dark fw-medium px-4 py-2 fw-bold shadow-sm" style="border-radius: 10px;">
            <i class="bi bi-plus-lg me-1"></i> {{ 'dashboard.new_inventory'|trans }}
        </a>
    </div>

    {# Tabs Section #}
    <ul class="nav nav-tabs mb-4 gap-2" id="inventoryTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="owned-tab" data-bs-toggle="tab" data-bs-target="#owned-pane" type="button" role="tab">
                <i class="bi bi-person me-2"></i>{{ 'dashboard.my_inventories'|trans }}
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="shared-tab" data-bs-toggle="tab" data-bs-target="#shared-pane" type="button" role="tab">
                <i class="bi bi-people me-2"></i>{{ 'dashboard.shared_with_me'|trans }}
                <span class="badge bg-light text-dark border ms-1 rounded-pill">{{ sharedInventories|length }}</span>
            </button>
        </li>
    </ul>

    <div class="tab-content">
        {# Owned Inventories #}
        <div class="tab-pane fade show active" id="owned-pane" role="tabpanel">
            <form id="bulk-form" method="POST">
                <div class="table-container shadow-sm">
                    {# Sticky Selection Bar #}
                    <div id="selection-bar" class="justify-content-between align-items-center">
                        <span class="small fw-bold"><span id="selected-count">0</span> {{ 'dashboard.selected_count'|trans }}</span>
                        <div class="d-flex gap-2">
                            {% if is_granted('ROLE_USER') %}
                                <button type="submit" formaction="{{ path('app_inventory_bulk_edit') }}" class="btn btn-sm btn-light fw-bold px-3">
                                    {{ 'dashboard.bulk_edit'|trans }}
                                </button>
                            {% endif %}
                            <button type="submit" formaction="{{ path('app_inventory_bulk_delete') }}" class="btn btn-sm btn-danger fw-bold px-3" onclick="return confirm('{{ 'dashboard.delete_confirm'|trans }}')">
                                {{ 'dashboard.bulk_delete'|trans }}
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table mb-0 align-middle">
                            <thead>
                                <tr>
                                    <th class="ps-4" style="width: 40px;"><input type="checkbox" id="select-all" class="form-check-input"></th>
                                    <th>{{ 'table.name'|trans }}</th>
                                    <th class="d-none d-md-table-cell">{{ 'table.tags'|trans }}</th>
                                    <th class="d-none d-md-table-cell">{{ 'table.category'|trans }}</th>
                                    <th class="text-center">{{ 'dashboard.visibility'|trans }}</th>
                                    <th class="text-end pe-4">{{ 'table.stored_items'|trans }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for inv in pagination %}
                                <tr class="inventory-row">
                                    <td class="ps-4">
                                        <input type="checkbox" name="ids[]" value="{{ inv.id }}" class="form-check-input inventory-checkbox">
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <a href="{{ path('app_inventory_show', {id: inv.id}) }}" class="inventory-link">{{ inv.title }}</a>
                                            <span class="text-muted small text-truncate" style="max-width: 200px;">
                                                {% set desc = inv.description|default('home.no_description'|trans) %}
                                                {{ desc|slice(0, 45) }}{{ desc|length > 45 ? '...' : '' }}
                                            </span>
                                        </div>
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <div class="d-flex flex-wrap gap-1">
                                            {% for tag in inv.tags %}
                                                <span class="badge rounded-pill bg-white text-muted border extra-small">#{{ tag }}</span>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <span class="badge-category">{{ inv.category ? inv.category.name : 'N/A' }}</span>
                                    </td>
                                    <td class="text-center">
                                        <i class="bi {{ inv.isPublic ? 'bi-globe-americas text-success' : 'bi-lock-fill text-muted' }}" style="font-size: 0.9rem;"></i>
                                    </td>
                                    <td class="text-end pe-4">
                                        <span class="item-count-badge">{{ inv.items|length }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </form>

            <div class="d-flex justify-content-center mt-5">
                {{ knp_pagination_render(pagination) }}
            </div>
        </div>

        {# Shared Inventories #}
        <div class="tab-pane fade" id="shared-pane" role="tabpanel">
            <div class="table-container shadow-sm">
                <div class="table-responsive">
                    <table class="table mb-0 align-middle">
                        <thead>
                            <tr>
                                <th class="ps-4">{{ 'table.name'|trans }}</th>
                                <th class="d-none d-md-table-cell">{{ 'table.owner'|trans }}</th>
                                <th class="text-center">{{ 'table.stored_items'|trans }}</th>
                                <th class="text-end pe-4">{{ 'table.actions'|trans }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for inv in sharedInventories %}
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex flex-column">
                                        <a href="{{ path('app_inventory_show', {id: inv.id}) }}" class="inventory-link">{{ inv.title }}</a>
                                        <span class="text-muted small d-md-none">{{ inv.creator.email }}</span>
                                    </div>
                                </td>
                                <td class="d-none d-md-table-cell small text-muted">{{ inv.creator.email }}</td>
                                <td class="text-center"><span class="item-count-badge">{{ inv.items|length }}</span></td>
                                <td class="text-end pe-4">
                                    <a href="{{ path('app_inventory_show', {id: inv.id}) }}" class="btn btn-sm btn-outline-dark fw-bold px-3" style="border-radius: 8px;">
                                        {{ 'table.view_edit'|trans }}
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-5 text-muted">{{ 'dashboard.no_shared'|trans }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.inventory-checkbox');
    const selectionBar = document.getElementById('selection-bar');
    const countDisplay = document.getElementById('selected-count');

    function updateUI() {
        const checked = document.querySelectorAll('.inventory-checkbox:checked');
        const checkedCount = checked.length;

        if (countDisplay) countDisplay.textContent = checkedCount;

        if (checkedCount > 0) {
            selectionBar.style.display = 'flex';
        } else {
            if (selectAll) selectAll.checked = false;
            selectionBar.style.display = 'none';
        }

        checkboxes.forEach(cb => {
            const row = cb.closest('tr');
            if (cb.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        });
    }

    if (selectAll) {
        selectAll.addEventListener('change', () => {
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateUI();
        });
    }

    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateUI);
    });
});
</script>
{% endblock %}