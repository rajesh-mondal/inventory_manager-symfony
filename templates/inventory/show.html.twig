{% extends 'base.html.twig' %}

{% block title %}{{ inventory.title }}{% endblock %}

{% block body %}

<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ path('app_my_inventories') }}">{{ 'inventory_show.breadcrumb_list'|trans }}</a></li>
            <li class="breadcrumb-item active">{{ inventory.title }}</li>
        </ol>
    </nav>

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-end mb-4 gap-3">
        <div>
            <h1 class="fw-bold tracking-tight text-dark mb-1 h2 h1-md">{{ inventory.title }}</h1>
            <div class="d-flex flex-wrap align-items-center gap-2">
                <span class="badge bg-light text-dark border">{{ inventory.category.name ?? 'No Category' }}</span>
                {% for tag in inventory.tags %}
                    <span class="badge rounded-pill bg-white text-muted border small">#{{ tag }}</span>
                {% endfor %}
            </div>
            {% if inventory.description %}
                <div class="inventory-description mt-3 text-secondary border-start ps-3" style="font-size: 0.95rem; max-width: 800px;">
                    {{ inventory.description|markdown_to_html }}
                </div>
            {% endif %}
        </div>
        <div class="d-flex d-md-flex gap-2">
            {% if is_granted('INVENTORY_EDIT', inventory) %}
                <a href="{{ path('app_item_new', {id: inventory.id}) }}" class="btn btn-dark px-4 py-2 fw-bold" style="border-radius: 8px;">
                    {{ 'inventory_show.add_item'|trans }}
                </a>
            {% endif %}
        </div>
    </div>

    <ul class="nav nav-tabs mb-4 flex-nowrap overflow-x-auto hide-scrollbar border-bottom-0 shadow-sm shadow-none-sm py-1"
        id="inventoryTabs"
        role="tablist"
        style="white-space: nowrap;">
        <li class="nav-item active" role="presentation">
            <button class="nav-link active" id="items-tab" data-bs-toggle="tab" data-bs-target="#items-pane" type="button" role="tab">
                <i class="bi bi-table me-2"></i>{{ 'inventory_show.tab_items'|trans }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="discussion-tab" data-bs-toggle="tab" data-bs-target="#discussion-pane" type="button" role="tab">
                <i class="bi bi-chat-left-text me-2"></i>{{ 'inventory_show.tab_discussion'|trans }}
            </button>
        </li>
        {% if is_granted('INVENTORY_EDIT', inventory) %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-pane" type="button" role="tab">
                <i class="bi bi-gear me-2"></i>{{ 'inventory_show.tab_settings'|trans }}
            </button>
        </li>
        {% endif %}
        {% if inventory.creator == app.user or is_granted('ROLE_ADMIN') %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="access-tab" data-bs-toggle="tab" data-bs-target="#access-pane" type="button" role="tab">
                <i class="bi bi-person-lock me-2"></i>{{ 'settings.manage_access'|trans }}
            </button>
        </li>
        {% endif %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-pane" type="button" role="tab">
                <i class="bi bi-bar-chart me-2"></i>{{ 'inventory_show.tab_stats'|trans }}
            </button>
        </li>
    </ul>

    <div class="tab-content" id="inventoryTabsContent">
        <div class="tab-pane fade show active" id="items-pane" role="tabpanel">
            <div class="table-container">
                {% if is_granted('INVENTORY_EDIT', inventory) or is_granted('INVENTORY_DELETE', inventory) %}
                    <div id="item-toolbar" class="bg-dark text-white p-3 d-none d-flex justify-content-between align-items-center">
                        <span id="selected-count" class="small fw-bold d-none d-sm-inline">{{ 'inventory_show.selected_count'|trans({'%count%': 0}) }}</span>
                        <div class="d-flex gap-2">
                            {% if is_granted('INVENTORY_EDIT', inventory) %}
                                <button type="button" onclick="bulkAction('edit')" class="btn btn-sm btn-light fw-bold">
                                    <i class="bi bi-pencil d-md-none"></i> <span class="d-none d-md-inline">{{ 'edit_inventory.edit'|trans }}</span>
                                </button>
                            {% endif %}
                            {% if is_granted('INVENTORY_DELETE', inventory) %}
                                <button type="button" onclick="bulkAction('delete')" class="btn btn-sm btn-danger fw-bold">
                                    <i class="bi bi-trash d-md-none"></i> <span class="d-none d-md-inline">{{ 'edit_inventory.delete'|trans }}</span>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
                <form id="bulk-form" method="POST">
                    <div class="table-responsive">
                        <table class="table mb-0" style="table-layout: auto;">
                            <thead>
                                <tr>
                                    {% if is_granted('INVENTORY_EDIT', inventory) %}
                                        <th class="col-checkbox">
                                            <input type="checkbox" id="select-all" class="form-check-input">
                                        </th>
                                    {% endif %}
                                    <th>{{ 'inventory_show.table.image'|trans }}</th>
                                    <th class="d-none d-sm-table-cell">{{ 'inventory_show.table.custom_id'|trans }}</th>
                                    <th>{{ 'inventory_show.table.item_name'|trans }}</th>

                                    {% for type in ['String', 'Int', 'Bool', 'Text'] %}
                                        {% for i in 1..3 %}
                                            {% if attribute(inventory, 'custom' ~ type ~ i ~ 'State') %}
                                                <th class="d-none d-md-table-cell {{ type == 'Bool' ? 'text-center' : '' }}">
                                                    {{ attribute(inventory, 'custom' ~ type ~ i ~ 'Name') }}
                                                </th>
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}

                                    <th class="text-end d-none d-lg-table-cell">{{ 'inventory_show.table.created'|trans }}</th>
                                    <th class="text-center">{{ 'inventory_show.table.likes'|trans }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in pagination %}
                                <tr class="item-row">
                                    {% if is_granted('INVENTORY_EDIT', inventory) %}
                                        <td class="col-checkbox">
                                            <input type="checkbox" name="item_ids[]" value="{{ item.id }}" class="item-checkbox form-check-input">
                                        </td>
                                    {% endif %}

                                    <td>
                                        {% if item.image %}
                                            <img src="{{ asset('uploads/items/' ~ item.image) }}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px;">
                                        {% else %}
                                            <div class="bg-light text-center" style="width: 40px; height: 40px; border-radius: 6px; line-height: 40px;">
                                                <i class="bi bi-image text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </td>

                                    <td class="d-none d-sm-table-cell">
                                        <code class="custom-id-badge">{{ item.customId }}</code>
                                    </td>
                                    <td class="fw-medium text-dark">{{ item.name }}</td>

                                    {% for type in ['String', 'Int', 'Bool', 'Text'] %}
                                        {% for i in 1..3 %}
                                            {% if attribute(inventory, 'custom' ~ type ~ i ~ 'State') %}
                                                {% set val = attribute(item, type|lower ~ 'Val' ~ i) %}
                                                <td class="d-none d-md-table-cell {{ type == 'Bool' ? 'text-center' : '' }}">
                                                    {% if type == 'Bool' %}
                                                        {% if val %}
                                                            <i class="bi bi-check-circle-fill text-success fs-5"></i>
                                                        {% else %}
                                                            <i class="bi bi-x-circle text-muted opacity-50"></i>
                                                        {% endif %}
                                                    {% else %}
                                                        {{ val|default('-') }}
                                                    {% endif %}
                                                </td>
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}

                                    <td class="text-end text-muted d-none d-lg-table-cell" style="font-size: 0.85rem;">
                                        {{ item.createdAt|date('M d, Y') }}
                                    </td>

                                    <td class="text-center">
                                        {% set isLiked = item.likes.contains(app.user) %}
                                        <button type="button"
                                                class="btn btn-sm rounded-pill like-btn {{ isLiked ? 'btn-danger text-white' : 'btn-outline-danger' }}"
                                                data-item-id="{{ item.id }}">
                                            <i class="bi {{ isLiked ? 'bi-heart-fill' : 'bi-heart' }}"></i>
                                            <span class="ms-1 like-count">{{ item.likes.count }}</span>
                                        </button>
                                    </td>
                                </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="20" class="text-center py-5 text-muted">
                                            {{ 'inventory_show.table.empty'|trans }}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="d-flex justify-content-center mt-5 mb-4 small">
                <div class="minimal-pagination d-flex gap-1 align-items-center">
                    {{ knp_pagination_render(pagination) }}
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="discussion-pane" role="tabpanel">
            <div class="card border-0 shadow-sm p-4">
                <div id="discussion-box" class="mb-3" style="height: 500px; overflow-y: auto;">
                    {% for comment in inventory.comments %}
                        <div class="d-flex mb-3 pb-3 border-bottom" data-id="{{ comment.id }}">
                            <div class="flex-shrink-0">
                                <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 38px; height: 38px;">
                                    {{ comment.author.userIdentifier|slice(0, 2)|upper }}
                                </div>
                            </div>
                            <div class="ms-3 flex-grow-1">
                                <div class="mb-1">
                                    <span class="fw-bold text-dark me-2">{{ comment.author.userIdentifier }}</span>
                                    <small class="text-muted">{{ comment.createdAt|date('d M Y, H:i') }}</small>
                                </div>
                                <div class="markdown-content-initial text-muted-dark invisible">
                                    {{ comment.content }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div class="input-group">
                    <textarea id="comment-input" class="form-control" placeholder="{{ 'inventory_show.discussion.placeholder'|trans }}"></textarea>
                    <button class="btn btn-dark" type="button" id="btn-post-comment"><i class="bi bi-send-fill"></i></button>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="stats-pane" role="tabpanel">
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm p-4 text-center h-100">
                        <span class="section-label">{{ 'inventory_show.stats.total_items'|trans }}</span>
                        <h2 class="fw-bold mt-2">{{ stats.totalItems }}</h2>
                        <p class="text-muted small mb-0">{{ 'inventory_show.stats.total_items_help'|trans }}</p>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card border-0 shadow-sm p-4 text-center h-100">
                        <span class="section-label">{{ 'inventory_show.stats.public_visibility'|trans }}</span>
                        <h2 class="fw-bold mt-2">
                            {% if inventory.isPublic %}
                                <i class="bi bi-eye text-success"></i>
                            {% else %}
                                <i class="bi bi-eye-slash text-muted"></i>
                            {% endif %}
                        </h2>
                        <p class="text-muted small mb-0">
                            {{ inventory.isPublic ? 'inventory_show.stats.visible_everyone'|trans : 'inventory_show.stats.private_you'|trans }}
                        }</p>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card border-0 shadow-sm p-4 text-center h-100">
                        <span class="section-label">{{ 'inventory_show.stats.engagement'|trans }}</span>
                        <h2 class="fw-bold mt-2 text-danger">
                            <i class="bi bi-heart-fill me-2"></i>{{ stats.totalLikes }}
                        </h2>
                        <p class="text-muted small mb-0">{{ 'inventory_show.stats.engagement_help'|trans }}</p>
                    </div>
                </div>

                <div class="col-12">
                    <div class="table-container p-4">
                        <span class="section-label mb-4"{{ 'inventory_show.stats.analysis'|trans }}</span>
                        <div class="row">
                            <div class="col-md-6 border-end">
                                <h6 class="fw-bold mb-3">{{ 'inventory_show.stats.averages'|trans }}</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-0 px-0">
                                        {# Dynamically use the name you gave to Custom Int 1 #}
                                        <span class="text-muted small">
                                            {{ 'inventory_show.stats.avg_label'|trans({'%name%': inventory.customInt1Name|default('Price')}) }}
                                        </span>
                                        <span class="fw-bold">{{ stats.avgPrice|number_format(2) }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-0 px-0">
                                        <span class="text-muted small">{{ 'inventory_show.stats.last_added'|trans }}</span>
                                        <span class="fw-bold text-truncate ms-2" style="max-width: 150px;">
                                            {{ inventory.items|last.name|default('N/A') }}
                                        </span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-0 px-0">
                                        <span class="text-muted small">{{ 'inventory_show.stats.last_updated'|trans }}</span>
                                        <span class="fw-bold small">
                                            {{ stats.lastUpdated ? stats.lastUpdated|date('M d, Y') : 'inventory_show.stats.never'|trans }}
                                        </span>
                                    </li>
                                </ul>
                            </div>

                            <div class="col-md-6 ps-md-4">
                                <h6 class="fw-bold mb-3">{{ 'inventory_show.stats.system_info'|trans }}</h6>
                                <p class="small text-muted mb-1">{{ 'inventory_show.stats.category'|trans }}</p>
                                <span class="badge bg-light text-dark border mb-3">
                                    {{ inventory.category.name|default('Uncategorized') }}
                                </span>

                                <p class="small text-muted mb-1">{{ 'inventory_form.tags_label'|trans }}:</p>
                                <div class="d-flex flex-wrap gap-1">
                                    {% if inventory.tags is not empty %}
                                        {% for tag in inventory.tags %}
                                            <span class="badge bg-dark-subtle text-dark" style="font-size: 0.7rem;">#{{ tag }}</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted small">{{ 'inventory_show.stats.no_tags'|trans }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="settings-pane" role="tabpanel" aria-labelledby="settings-tab">
            {% if is_granted('INVENTORY_EDIT', inventory) %}
                <div class="card border-0 shadow-sm p-4">
                    <div id="autosave-status" class="small mb-2" style="height: 20px; font-weight: 500;"></div>
                    <form id="settings-form" method="POST" action="{{ path('app_inventory_settings', {id: inventory.id}) }}">
                        <input type="hidden" name="version" id="inventory-version" value="{{ inventory.version }}">
                        <span class="section-label d-block mb-3" style="font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #9ca3af; letter-spacing: 0.05em;">
                            {{ 'edit_inventory.update_fields'|trans }}
                        </span>
                        <p class="text-muted small mb-4">{{ 'edit_inventory.settings_help'|trans }}</p>

                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">{{ 'edit_inventory.title_readonly'|trans }}</label>
                                <input type="text" class="form-control bg-light" value="{{ inventory.title }}" readonly>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold small">{{ 'inventory_form.category_label'|trans }}</label>
                                <select name="category" class="form-select">
                                    <option value="">{{ 'edit_inventory.select_category_default'|trans }}</option>
                                    {% for cat in categories %}
                                        <option value="{{ cat.id }}"
                                            {% if inventory.category and inventory.category.id == cat.id %}selected{% endif %}>
                                            {{ cat.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold small">{{ 'edit_inventory.tags_label'|trans }}</label>
                                <input type="text" name="tags" class="form-control" value="{{ inventory.tags|join(', ') }}" placeholder="e.g. electronics, home, storage">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold small">{{ 'edit_inventory.visibility'|trans }}</label>
                                <select name="is_public" class="form-select">
                                    <option value="1" {% if inventory.isPublic %}selected{% endif %}>{{ 'edit_inventory.public'|trans }}</option>
                                    <option value="0" {% if not inventory.isPublic %}selected{% endif %}>{{ 'edit_inventory.private'|trans }}</option>
                                </select>
                            </div>

                            <div class="col-md-12">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label fw-bold small mb-0">{{ 'inventory_form.description_label'|trans }}</label>
                                    <span class="text-muted extra-small">
                                        <i class="bi bi-markdown me-1"></i>
                                        {{ 'inventory_form.markdown_support'|trans }}
                                    </span>
                                </div>
                                <textarea name="description"
                                          class="form-control"
                                          rows="5"
                                          placeholder="Use **bold**, # headers, or - lists."
                                          style="font-size: 0.85rem;"
                                >{{ inventory.description }}</textarea>
                            </div>
                        </div>

                        <div class="mt-5 pt-4 border-top d-flex justify-content-end">
                            <button type="submit" class="btn btn-dark px-5 fw-bold" style="border-radius: 8px;">
                                {{ 'edit_inventory.save_changes'|trans }}
                            </button>
                        </div>
                    </form>
                </div>
            {% else %}
                <div class="alert alert-warning">
                    {{ 'inventory_show.no_permission'|trans|default('You do not have permission to edit this inventory.') }}
                </div>
            {% endif %}
        </div>

        <div class="tab-pane fade" id="access-pane" role="tabpanel">
            {% if inventory.creator == app.user or is_granted('ROLE_ADMIN') %}
                <div class="card border-0 shadow-sm p-4">
                    <span class="section-label d-block mb-3">
                        {{ 'settings.manage_access'|trans }}
                    </span>
                    <p class="text-muted small mb-4">{{ 'settings.access_help'|trans }}</p>

                    <form action="{{ path('app_inventory_settings', {id: inventory.id}) }}" method="POST" class="mb-4">
                        <div class="input-group" style="max-width: 500px;">
                            <input type="email"
                                   name="grant_access_email"
                                   class="form-control shadow-none"
                                   placeholder="user@example.com"
                                   required
                                   style="border-radius: 8px 0 0 8px;">
                            <button type="submit" class="btn btn-dark px-4" style="border-radius: 0 8px 8px 0;">
                                {{ 'settings.grant_access'|trans }}
                            </button>
                        </div>
                    </form>

                    <div class="access-list mt-2">
                        <h6 class="small fw-bold text-uppercase text-muted mb-3">{{ 'settings.users_with_access'|trans }}</h6>
                        <ul class="list-group list-group-flush" style="max-width: 600px;">

                            <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">
                                <div>
                                    <span class="fw-medium text-dark">{{ inventory.creator.email }}</span>
                                    <span class="badge bg-light text-dark border ms-2 rounded-pill small px-3">
                                        {{ 'settings.role_owner'|trans }}
                                    </span>
                                </div>
                            </li>

                            {% for userWithAccess in inventory.writeAccessUsers %}
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">
                                    <span class="text-muted small">{{ userWithAccess.email }}</span>

                                    <form action="{{ path('app_inventory_settings', {id: inventory.id}) }}"
                                          method="POST"
                                          onsubmit="return confirm('{{ 'settings.revoke_confirm'|trans|escape('js') }}');">
                                        <input type="hidden" name="revoke_access_id" value="{{ userWithAccess.id }}">
                                        <button type="submit" class="btn btn-link text-danger p-0 border-0 shadow-none">
                                            <i class="bi bi-x-circle fs-5"></i>
                                        </button>
                                    </form>
                                </li>
                            {% else %}
                                <li class="list-group-item px-0 text-muted small py-3 border-0 italic">
                                    {{ 'settings.no_extra_users'|trans }}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-light border m-4 text-center">
                    <i class="bi bi-shield-lock me-2"></i>
                    {{ 'inventory_show.no_permission_admin'|trans|default('Only the owner or an admin can manage access permissions.') }}
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
    let lastCommentId = {{ lastCommentId|default(0) }};

    document.addEventListener('DOMContentLoaded', function() {
        const inventoryId = {{ inventory.id }};

        // Settings auto-save logic
        const settingsForm = document.getElementById('settings-form');
        const statusEl = document.getElementById('autosave-status');
        const versionInput = document.getElementById('inventory-version');
        let isDirty = false;

        if (settingsForm) {
            settingsForm.addEventListener('input', () => {
                isDirty = true;
                if (statusEl) statusEl.innerHTML = '<span class="text-muted small">Unsaved changes...</span>';
            });

            setInterval(() => {
                if (!isDirty) return;
                if (statusEl) statusEl.innerHTML = '<span class="text-primary small">Saving...</span>';

                const formData = new FormData(settingsForm);
                const data = Object.fromEntries(formData.entries());

                fetch(settingsForm.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (response.status === 409) throw new Error('Conflict: Modified elsewhere');
                    if (!response.ok) throw new Error('Save failed');
                    return response.json();
                })
                .then(result => {
                    if (result.newVersion && versionInput) {
                        versionInput.value = result.newVersion;
                    }
                    isDirty = false;
                    if (statusEl) {
                        statusEl.innerHTML = '<span class="text-success small"><i class="bi bi-check-circle"></i> Saved</span>';
                        setTimeout(() => { if(!isDirty) statusEl.innerText = ''; }, 3000);
                    }
                })
                .catch(error => {
                    if (statusEl) {
                        statusEl.innerHTML = `<span class="text-danger small"><i class="bi bi-exclamation-triangle"></i> ${error.message}</span>`;
                    }
                });
            }, 7000);
        }

        // Tabs and selection
        const hash = window.location.hash;
        if (hash) {
            const targetTab = document.querySelector(`button[data-bs-target="${hash}"]`);
            if (targetTab) new bootstrap.Tab(targetTab).show();
        }

        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(btn => {
            btn.addEventListener('shown.bs.tab', (e) => {
                history.replaceState(null, null, e.target.getAttribute('data-bs-target'));
            });
        });

        const selectAll = document.getElementById('select-all');
        const checkboxes = document.querySelectorAll('.item-checkbox');
        const toolbar = document.getElementById('item-toolbar');
        const countDisplay = document.getElementById('selected-count');

        function updateToolbar() {
            const checkedCount = document.querySelectorAll('.item-checkbox:checked').length;
            if (toolbar) {
                if (checkedCount > 0) {
                    toolbar.classList.remove('d-none');
                    countDisplay.innerText = `${checkedCount} item(s) selected`;
                } else {
                    toolbar.classList.add('d-none');
                }
            }
        }

        if (selectAll) {
            selectAll.addEventListener('change', function() {
                checkboxes.forEach(cb => cb.checked = selectAll.checked);
                updateToolbar();
            });
        }

        checkboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                const row = this.closest('tr');
                if (this.checked) row.classList.add('selected');
                else row.classList.remove('selected');
                updateToolbar();
            });
        });

        // Like buttins logic
        document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const itemId = this.dataset.itemId;
                fetch(`/item/${itemId}/like`, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(res => res.json())
                .then(data => {
                    if (data.likesCount !== undefined) {
                        this.querySelector('.like-count').innerText = data.likesCount;
                        this.classList.toggle('btn-outline-danger');
                        this.classList.toggle('btn-danger');
                        this.querySelector('i').classList.toggle('bi-heart');
                        this.querySelector('i').classList.toggle('bi-heart-fill');
                    }
                });
            });
        });

        // Discuss polling
        const discussionBox = document.getElementById('discussion-box');
        const commentInput = document.getElementById('comment-input');
        const postBtn = document.getElementById('btn-post-comment');

        document.querySelectorAll('.markdown-content-initial').forEach(el => {
            el.innerHTML = marked.parse(el.textContent.trim());
            el.classList.remove('invisible');
        });

        const scrollToBottom = () => { if(discussionBox) discussionBox.scrollTop = discussionBox.scrollHeight; };
        scrollToBottom();

        if (postBtn) {
            postBtn.addEventListener('click', function() {
                const content = commentInput.value.trim();
                if (!content) return;
                fetch(`/inventory/${inventoryId}/comments/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    body: JSON.stringify({ content: content })
                })
                .then(res => res.json())
                .then(data => { if (data.status === 'success') commentInput.value = ''; });
            });
        }

        setInterval(function() {
            fetch(`/inventory/${inventoryId}/comments/updates?lastId=` + lastCommentId)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        data.forEach(comment => {
                            if (document.querySelector(`[data-id="${comment.id}"]`)) return;

                            const htmlContent = marked.parse(comment.content);
                            const initials = comment.author.substring(0, 2).toUpperCase();
                            const html = `
                                <div class="d-flex mb-3 pb-3 border-bottom" data-id="${comment.id}">
                                    <div class="flex-shrink-0">
                                        <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 38px; height: 38px; font-size: 0.85rem; font-weight: bold;">
                                            ${initials}
                                        </div>
                                    </div>
                                    <div class="ms-3 flex-grow-1">
                                        <div class="mb-1">
                                            <span class="fw-bold text-dark me-2">${comment.author}</span>
                                            <small class="text-muted">${comment.date}</small>
                                        </div>
                                        <div class="text-muted-dark">${htmlContent}</div>
                                    </div>
                                </div>`;
                            discussionBox.insertAdjacentHTML('beforeend', html);

                            if (comment.id > lastCommentId) lastCommentId = comment.id;
                        });
                        scrollToBottom();
                    }
                });
        }, 3000);
    });

    // Bulk action
    function bulkAction(type) {
        const form = document.getElementById('bulk-form');
        if (!form) return;
        form.action = type === 'delete' ? "{{ path('app_item_bulk_delete') }}" : "{{ path('app_item_bulk_edit') }}";
        if (type !== 'delete' || confirm('Delete selected?')) form.submit();
    }
</script>
{% endblock %}